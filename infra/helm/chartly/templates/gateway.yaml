{{- if .Values.services.gateway.enabled -}}

{{- $ns := .Values.global.namespace -}}

{{- /* Require selectorLabels (critical contract) */ -}}
{{- $sel := required "services.gateway.selectorLabels is required" .Values.services.gateway.selectorLabels -}}

{{- /* Build image as a single scalar string */ -}}
{{- $img := printf "%s:%s" .Values.services.gateway.image.repository .Values.services.gateway.image.tag -}}
{{- if .Values.global.image.registry -}}
{{- $img = printf "%s/%s" .Values.global.image.registry $img -}}
{{- end -}}

{{- /* Pod securityContext: prefer per-service override if present; omit non-security keys */ -}}
{{- $podSC := .Values.global.security.pod -}}
{{- with .Values.services.gateway.security -}}
{{- if .pod -}}
{{- $podSC = .pod -}}
{{- end -}}
{{- end -}}
{{- $podSC = omit $podSC "terminationGracePeriodSeconds" -}}

{{- /* Container securityContext: prefer per-service override if present */ -}}
{{- $ctrSC := .Values.global.security.container -}}
{{- with .Values.services.gateway.security -}}
{{- if .container -}}
{{- $ctrSC = .container -}}
{{- end -}}
{{- end -}}

{{- /* terminationGracePeriodSeconds is PodSpec-level */ -}}
{{- $tgp := (dig "global" "security" "pod" "terminationGracePeriodSeconds" .Values | default 30) -}}

{{- /* Writable tmp: prefer per-service tmp config if present, else global tmp */ -}}
{{- $tmp := dict "enabled" false "mountPath" "/tmp" -}}
{{- with (dig "global" "security" "writablePaths" "tmp" .Values) -}}
{{- if . -}}
{{- $tmp = . -}}
{{- end -}}
{{- end -}}
{{- with (dig "services" "gateway" "writablePaths" "tmp" .Values) -}}
{{- if . -}}
{{- $tmp = . -}}
{{- end -}}
{{- end -}}

{{- /* Probe values (nil-safe via dig) */ -}}
{{- $rPath := (dig "services" "gateway" "probes" "readiness" "path" .Values | default "/ready") -}}
{{- $rDelay := (dig "services" "gateway" "probes" "readiness" "initialDelaySeconds" .Values | default 3) -}}
{{- $rPeriod := (dig "services" "gateway" "probes" "readiness" "periodSeconds" .Values | default 5) -}}

{{- $lPath := (dig "services" "gateway" "probes" "liveness" "path" .Values | default "/health") -}}
{{- $lDelay := (dig "services" "gateway" "probes" "liveness" "initialDelaySeconds" .Values | default 10) -}}
{{- $lPeriod := (dig "services" "gateway" "probes" "liveness" "periodSeconds" .Values | default 10) -}}

{{- $sPath := (dig "services" "gateway" "probes" "startup" "path" .Values | default "/health") -}}
{{- $sPeriod := (dig "services" "gateway" "probes" "startup" "periodSeconds" .Values | default 2) -}}
{{- $sFail := (dig "services" "gateway" "probes" "startup" "failureThreshold" .Values | default 30) -}}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: chartly-gateway
  namespace: {{ $ns | quote }}
  labels:
    {{- toYaml .Values.global.labels | nindent 4 }}
    app.kubernetes.io/component: gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- toYaml $sel | nindent 6 }}
  template:
    metadata:
      labels:
        {{- toYaml .Values.global.labels | nindent 8 }}
        app.kubernetes.io/component: gateway
        {{- toYaml $sel | nindent 8 }}
    spec:
      automountServiceAccountToken: {{ .Values.global.security.automountServiceAccountToken }}
      terminationGracePeriodSeconds: {{ $tgp }}
      securityContext:
        {{- toYaml $podSC | nindent 8 }}
      containers:
        - name: gateway
          image: {{ $img | quote }}
          imagePullPolicy: {{ .Values.global.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.services.gateway.service.port }}
              protocol: TCP
          securityContext:
            {{- toYaml $ctrSC | nindent 12 }}
          readinessProbe:
            httpGet:
              path: {{ $rPath | quote }}
              port: http
            initialDelaySeconds: {{ $rDelay }}
            periodSeconds: {{ $rPeriod }}
          livenessProbe:
            httpGet:
              path: {{ $lPath | quote }}
              port: http
            initialDelaySeconds: {{ $lDelay }}
            periodSeconds: {{ $lPeriod }}
          startupProbe:
            httpGet:
              path: {{ $sPath | quote }}
              port: http
            periodSeconds: {{ $sPeriod }}
            failureThreshold: {{ $sFail }}
          {{- with .Values.services.gateway.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if $tmp.enabled }}
          volumeMounts:
            - name: tmp
              mountPath: {{ $tmp.mountPath | default "/tmp" | quote }}
          {{- end }}
      {{- if $tmp.enabled }}
      volumes:
        - name: tmp
          emptyDir: {}
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: chartly-gateway
  namespace: {{ $ns | quote }}
  labels:
    {{- toYaml .Values.global.labels | nindent 4 }}
    app.kubernetes.io/component: gateway
spec:
  type: {{ .Values.services.gateway.service.type }}
  selector:
    {{- toYaml $sel | nindent 4 }}
  ports:
    - name: http
      port: {{ .Values.services.gateway.service.port }}
      targetPort: http
      protocol: TCP

{{- end -}}
