name: ci

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  sanity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify critical files exist
        shell: bash
        run: |
          set -euo pipefail
          required=(
            "README.md"
            "LICENSE"
            ".gitignore"
            ".editorconfig"
            ".env.example"
            "ARCHITECTURE.md"
            "MANIFEST.yaml"
            "SECURITY.md"
            "CHANGELOG.md"
            "docker-compose.yml"
            "go.mod"
            "go.work"
          )
          for f in "${required[@]}"; do
            test -e "$f" || (echo "Missing required file: $f" && exit 1)
          done
          echo "Sanity checks passed."

  go:
    runs-on: ubuntu-latest
    needs: sanity
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

            - name: Detect Go files
        id: gofiles
        shell: bash
        run: |
          set -euo pipefail
          total=$(find . -name '*.go' -not -path './web/*' | wc -l | tr -d ' ')
          pkg=$(grep -R --include='*.go' --exclude-dir=web -n '^package ' . 2>/dev/null | wc -l | tr -d ' ')
          echo "total=$total" >> "$GITHUB_OUTPUT"
          echo "pkg=$pkg" >> "$GITHUB_OUTPUT"
          echo "Go files total: $total, with package: $pkg"

      - name: gofmt (check)
        if: ${{ steps.gofiles.outputs.total != '0' && steps.gofiles.outputs.total == steps.gofiles.outputs.pkg }}
        shell: bash
        run: |
          set -euo pipefail
          unformatted=$(gofmt -l $(find . -name '*.go' -not -path './web/*'))
          if [ -n "$unformatted" ]; then
            echo "Unformatted Go files:"
            echo "$unformatted"
            exit 1
          fi

      - name: go vet
        if: ${{ steps.gofiles.outputs.total != '0' && steps.gofiles.outputs.total == steps.gofiles.outputs.pkg }}
        shell: bash
        run: |
          set -euo pipefail
          go vet ./...

      - name: go test
        if: ${{ steps.gofiles.outputs.total != '0' && steps.gofiles.outputs.total == steps.gofiles.outputs.pkg }}
        shell: bash
        run: |
          set -euo pipefail
          go test ./...

      - name: Skip Go checks (no complete Go files yet)
        if: ${{ steps.gofiles.outputs.total == '0' }}
        run: echo "No complete Go files found (missing package decl); skipping gofmt/vet/test."

  contracts-validate:
    runs-on: ubuntu-latest
    needs: sanity
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check validator exists
        id: pycheck
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "contracts/validators/validate.py" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run contract validator
        if: ${{ steps.pycheck.outputs.exists == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          python contracts/validators/validate.py

      - name: Skip contracts validation (validator missing)
        if: ${{ steps.pycheck.outputs.exists == 'false' }}
        run: echo "contracts/validators/validate.py not found; skipping."

  web-check:
    runs-on: ubuntu-latest
    needs: sanity
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect web app
        id: web
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "web/package.json" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        if: ${{ steps.web.outputs.exists == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install deps
        if: ${{ steps.web.outputs.exists == 'true' }}
        working-directory: web
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Lint (if script exists)
        if: ${{ steps.web.outputs.exists == 'true' }}
        working-directory: web
        shell: bash
        run: |
          set -euo pipefail
          npm run -s lint || echo "No lint script; skipping."

      - name: Test (if script exists)
        if: ${{ steps.web.outputs.exists == 'true' }}
        working-directory: web
        shell: bash
        run: |
          set -euo pipefail
          npm test --silent || echo "No test script; skipping."

      - name: Skip web checks (no web app)
        if: ${{ steps.web.outputs.exists == 'false' }}
        run: echo "web/package.json not found; skipping."


