version: "1.0"

connector_profile:
  id: "grpc"
  protocol: "grpc"
  kind: "api"
  description: >
    gRPC connector profile. Defines safe configuration for calling unary and streaming gRPC methods,
    enforcing TLS, authentication metadata (via env refs), rate limiting, retries, and batching of responses
    into raw blobs for downstream normalization.
  version: "1.0.0"
  status: "active"

source_config_schema:
  required_fields:
    - "target"
    - "service"
    - "method"
  optional_fields:
    - "tls"
    - "metadata"
    - "timeout_seconds"
    - "call_type"
    - "request"
    - "streaming"
    - "rate_limit_rpm"
    - "retries"
  field_docs:
    target:
      type: "string"
      rules:
        - "Must be host:port (no scheme)."
        - "No embedded credentials."
    service:
      type: "string"
      rules:
        - "Fully qualified service name (protobuf package + service)."
    method:
      type: "string"
      rules:
        - "Method name on the service."
    call_type:
      type: "string"
      allowed: ["unary", "server_stream", "client_stream", "bidi_stream"]
      default: "unary"
    metadata:
      type: "object"
      rules:
        - "Auth metadata values must use env refs only."
    request:
      type: "object"
      rules:
        - "Deterministic request payload."
        - "Proto mapping is implementation-defined; base stores request as JSON artifact for audit when enabled."

grpc:
  target_policy:
    require_tls_in_prod: true
    forbid_embedded_credentials: true
  tls:
    defaults:
      enabled: true
      verify: true
      min_version: "1.2"
      ca_cert_env: ""     # optional
      client_cert_env: "" # optional
      client_key_env: ""  # optional
    env_ref_required_for_certs: true
  auth_metadata_policy:
    env_ref_syntax: "${ENV:VAR_NAME}"
    forbidden_keys: ["authorization"]   # prefer "Authorization" exact casing
    notes:
      - "Use metadata keys like 'Authorization' with env refs."
  call_selection:
    service_method_required: true
    reflection_planned: true
    notes:
      - "gRPC reflection can simplify discovery but is not required for v0."

streaming:
  supported_call_types: ["unary", "server_stream", "client_stream", "bidi_stream"]
  defaults:
    call_type: "unary"
  batching_for_streams:
    enabled: true
    max_batch_seconds: 5
    max_messages_per_batch: 500
    max_batch_bytes: 5000000
    buffer_limits:
      max_buffered_messages: 5000
      max_buffered_bytes: 20000000
      on_exceed: "disconnect_and_retry"
  notes:
    - "Streaming responses must be batched into raw blobs to preserve auditability and avoid memory pressure."

rate_limiting_and_backpressure:
  defaults:
    rate_limit_rpm: 60
    per_target_concurrency: 5
  backpressure:
    - "Stop initiating new calls when downstream queue depth exceeds threshold."
    - "For streams, disconnect gracefully when buffers exceed limits."

retries_and_circuit_breakers:
  retry_policy:
    retry_on_codes:
      - "UNAVAILABLE"
      - "DEADLINE_EXCEEDED"
      - "RESOURCE_EXHAUSTED"
    max_attempts: 3
    base_backoff_ms: 750
    max_backoff_ms: 12000
    jitter: true
  circuit_breaker:
    enabled: true
    failure_threshold: 8
    open_seconds: 90
    half_open_probe_requests: 2

payload_handling:
  response_storage:
    format: "json_lines_for_streams"
    unary_format: "json_object"
    content_type_labels:
      unary: "application/json"
      stream: "application/x-ndjson"
  raw_ref_requirements:
    - "Store each unary response as a raw blob with sha256."
    - "Store each stream batch as a raw blob with sha256."
    - "Include request metadata (service/method/call_type) in job meta, not in canonical outputs by default."
  max_payload_bytes_per_call: 10000000

observability:
  required_metrics:
    - "grpc.calls_total"
    - "grpc.errors_total"
    - "grpc.latency_ms_p95"
    - "grpc.stream_messages_total"
    - "grpc.batches_written_total"
    - "circuit_breaker.opens_total"
  required_log_fields:
    - "ts"
    - "service=connector-hub"
    - "tenant_id"
    - "source_id"
    - "job_id"
    - "target"
    - "grpc_service"
    - "grpc_method"
    - "call_type"
    - "status_code"
    - "latency_ms"
    - "raw_sha256"

llm_assist:
  enabled: true
  allowed_roles: ["schema_drift_explainer"]
  forbidden:
    - "include_secret_values"
    - "disable_tls"
    - "increase_stream_buffers_without_human_approval"
  approval_gate: "human_required"
  audit_fields_required: ["llm_role", "model_id", "prompt_hash", "output_hash", "approver", "decision"]

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example: Unary call with Authorization metadata via env var
# source:
#   kind: api
#   connector: grpc
#   config:
#     target: "grpc.example.com:443"
#     service: "example.v1.MetricsService"
#     method: "ListMetrics"
#     call_type: "unary"
#     timeout_seconds: 20
#     metadata:
#       Authorization: "Bearer ${ENV:EXAMPLE_GRPC_TOKEN}"
# -----------------------------------------------------------------------------
