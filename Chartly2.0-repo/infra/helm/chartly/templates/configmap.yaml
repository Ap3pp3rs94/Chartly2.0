{{- $ns := .Values.global.namespace -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: chartly-platform-config
  namespace: {{ $ns | quote }}
  labels:
    {{- toYaml .Values.global.labels | nindent 4 }}
    app.kubernetes.io/component: config
data:
  # Non-secret, shared platform defaults.
  CHARTLY_NAMESPACE: {{ $ns | quote }}
  CHARTLY_ENV: {{ (dig "global" "labels" "app.kubernetes.io/version" .Values | default "dev") | quote }}
  CHARTLY_LOG_LEVEL: {{ (dig "global" "config" "logLevel" .Values | default "info") | quote }}

---
{{- if (dig "monitoring" "prometheus" "enabled" .Values | default false) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: chartly-prometheus-config
  namespace: {{ $ns | quote }}
  labels:
    {{- toYaml .Values.global.labels | nindent 4 }}
    app.kubernetes.io/component: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: chartly-gateway
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-gateway.{{ $ns }}.svc.cluster.local:{{ (dig "services" "gateway" "service" "port" .Values | default 8080) }}

      - job_name: chartly-orchestrator
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-orchestrator.{{ $ns }}.svc.cluster.local:{{ (dig "services" "orchestrator" "service" "port" .Values | default 8081) }}

      - job_name: chartly-connector-hub
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-connector-hub.{{ $ns }}.svc.cluster.local:{{ (dig "services" "connectorHub" "service" "port" .Values | default 8082) }}

      - job_name: chartly-normalizer
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-normalizer.{{ $ns }}.svc.cluster.local:{{ (dig "services" "normalizer" "service" "port" .Values | default 8083) }}

      - job_name: chartly-analytics
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-analytics.{{ $ns }}.svc.cluster.local:{{ (dig "services" "analytics" "service" "port" .Values | default 8084) }}

      - job_name: chartly-storage
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-storage.{{ $ns }}.svc.cluster.local:{{ (dig "services" "storage" "service" "port" .Values | default 8085) }}

      - job_name: chartly-audit
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-audit.{{ $ns }}.svc.cluster.local:{{ (dig "services" "audit" "service" "port" .Values | default 8086) }}

      - job_name: chartly-auth
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-auth.{{ $ns }}.svc.cluster.local:{{ (dig "services" "auth" "service" "port" .Values | default 8087) }}

      - job_name: chartly-observer
        metrics_path: {{ (dig "monitoring" "prometheus" "scrape" "metricsPath" .Values | default "/metrics") }}
        static_configs:
          - targets:
              - chartly-observer.{{ $ns }}.svc.cluster.local:{{ (dig "services" "observer" "service" "port" .Values | default 8088) }}
{{- end }}

---
{{- if (dig "monitoring" "grafana" "enabled" .Values | default false) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: chartly-grafana-provisioning
  namespace: {{ $ns | quote }}
  labels:
    {{- toYaml .Values.global.labels | nindent 4 }}
    app.kubernetes.io/component: grafana
data:
  datasource.yaml: |
    apiVersion: 1
    datasources:
      - name: Chartly Prometheus
        type: prometheus
        access: proxy
        url: http://chartly-prometheus.{{ $ns }}.svc.cluster.local:{{ (dig "monitoring" "prometheus" "service" "port" .Values | default 9090) }}
        isDefault: true
        editable: true
{{- end }}
