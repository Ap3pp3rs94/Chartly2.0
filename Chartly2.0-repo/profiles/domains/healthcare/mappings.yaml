version: "1.0"

inherits:
  base_mappings_file: "profiles/core/base/mappings.yaml"
  override_strategy:
    - "extend: mapping_rules"
    - "tighten: dimension allowlist and PHI-safe principles"
    - "do_not_change: determinism rules, raw_ref binding, contract enforcement"

phi_safe_mapping_principles:
  - "Do not map patient-identifying fields into canonical outputs."
  - "Prefer aggregate metrics (counts, averages) over per-patient records."
  - "If identifiers are required (provider_id), use hashed forms only."
  - "Never include free-text clinical notes in canonical payloads."
  - "Use allowlisted dimensions only (facility_id, department, encounter_type, provider_id_hash, region, interval)."
  - "If PHI-like keys are detected, rely on cleansing+rules to redact/quarantine."

allowed_dimensions:
  allowlist_keys:
    - "facility_id"
    - "department"
    - "encounter_type"
    - "provider_id_hash"
    - "region"
    - "interval"
  notes:
    - "Any other dimension keys must be dropped or quarantined per phi_handling.yaml."

mapping_rules:
  encounter_counts_from_array:
    enabled: true
    description: "Map an array of encounter summaries into encounter count metrics (no patient identifiers)."
    expected_input_shape: "payload is array of objects"
    required_fields_hint: ["encounter_type", "facility_id", "timestamp"]
    output:
      metric_name_template: "healthcare.encounters.count"
      ts_selector_priority: ["ts", "timestamp", "date", "created_at"]
      value: 1
      dimensions:
        facility_id: "payload[*].facility_id"
        department: "payload[*].department (optional)"
        encounter_type: "payload[*].encounter_type"
        region: "payload[*].region (optional)"
        interval: "payload[*].interval (optional)"
    notes:
      - "Emit one metric per encounter item with value=1; downstream aggregation produces counts."

  wait_time_metrics_from_array:
    enabled: true
    description: "Map wait time fields into metrics (aggregated by facility/department)."
    expected_input_shape: "payload is array of objects"
    required_fields_hint: ["wait_time_minutes", "facility_id", "timestamp"]
    output:
      metric_name_template: "healthcare.wait_time.minutes"
      ts_selector_priority: ["ts", "timestamp", "date"]
      value_field_hint: "wait_time_minutes"
      dimensions:
        facility_id: "payload[*].facility_id"
        department: "payload[*].department (optional)"
        encounter_type: "payload[*].encounter_type (optional)"
        region: "payload[*].region (optional)"
    notes:
      - "Do not include per-patient identifiers."
      - "Negative wait times are invalid and should be quarantined by rules."

  billing_totals_from_object:
    enabled: true
    description: "Map a billing summary object into total charges metric (no individual accounts)."
    expected_input_shape: "payload is object"
    required_fields_hint: ["total_charges", "as_of"]
    output:
      metric_name_template: "healthcare.billing.total_charges"
      ts_field_hint: "as_of"
      value_field_hint: "total_charges"
      dimensions:
        facility_id: "payload.facility_id (optional)"
        department: "payload.department (optional)"
        region: "payload.region (optional)"
        interval: "payload.interval (optional)"
    notes:
      - "Account-level details are not permitted in canonical outputs under this domain profile."

  webhook_alert_event:
    enabled: true
    description: "Map inbound webhook alerts into PHI-safe canonical events."
    expected_input_shape: "payload is object"
    required_fields_hint: ["alert_type", "timestamp"]
    output:
      event_type: "healthcare.alert.received"
      ts_field_hint: "timestamp"
      payload_allowlist:
        - "alert_type"
        - "severity"
        - "facility_id"
        - "department"
        - "region"
      notes:
        - "Explicitly allowlist payload fields to avoid PHI leakage."
        - "Any additional fields should be dropped or quarantined."

  patient_entity_inference:
    enabled: false
    description: "Explicitly disabled in healthcare domain to prevent PHI expansion into canonical entities."

validation_notes:
  - "All outputs MUST validate against contracts/v1 canonical schemas."
  - "Any non-allowlisted dimensions or PHI-like fields must be dropped/quarantined per phi_handling.yaml."
  - "LLM suggestions must never use raw PHI samples; only redacted/minimized inputs."

llm_assist:
  enabled: true
  allowed_roles: ["mapping_suggester"]
  approval_gate: "human_required"
  constraints:
    - "LLM must not be provided raw PHI payloads."
    - "LLM must not propose adding non-allowlisted dimensions."
    - "LLM must not enable entity inference."
  audit_fields_required: ["llm_role", "model_id", "prompt_hash", "output_hash", "approver", "decision"]

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example 1: Encounter payload (no patient fields)
# payload:
#   - { facility_id: "F1", encounter_type: "ED", department: "ER", wait_time_minutes: 34, timestamp: "2026-01-21T10:00:00Z" }
# -> metrics:
#   - healthcare.encounters.count value=1 dims={facility_id:F1, encounter_type:ED, department:ER}
#   - healthcare.wait_time.minutes value=34 dims={facility_id:F1, encounter_type:ED, department:ER}
#
# Example 2: Billing summary payload
# payload:
#   { as_of: "2026-01-21T00:00:00Z", total_charges: 123456.78, facility_id: "F1" }
# -> metric: healthcare.billing.total_charges value=123456.78 dims={facility_id:F1}
# -----------------------------------------------------------------------------
