version: "1.0"

inherits:
  base_mappings_file: "profiles/core/base/mappings.yaml"
  override_strategy:
    - "extend: mapping_rules"
    - "override: naming conventions and standard dimensions"
    - "do_not_change: determinism rules, raw_ref binding, contract enforcement"

ecommerce_naming:
  metric_namespaces:
    - "orders"
    - "revenue"
    - "aov"
    - "conversion"
    - "inventory"
  metric_name_convention:
    - "Use dot-separated namespaces: <namespace>.<subject>.<unit_or_variant>"
    - "Examples: orders.count, revenue.total.usd, inventory.available, conversion.rate"
  event_types:
    convention: "ecommerce.<topic>.<action>"
    examples:
      - "ecommerce.order.received"
      - "ecommerce.inventory.updated"
      - "ecommerce.checkout.started"

standard_dimensions:
  required:
    - key: "store_id"
      description: "Store identifier (non-PII)."
      max_len: 64
    - key: "channel"
      description: "Sales channel (web, pos, marketplace)."
      max_len: 32
    - key: "currency"
      description: "Currency code (ISO 4217)."
      max_len: 8
  optional:
    - key: "sku"
      description: "Product SKU (non-PII)."
      max_len: 64
    - key: "category"
      description: "Product category."
      max_len: 64
    - key: "region"
      description: "Region/country code."
      max_len: 16
    - key: "interval"
      description: "Sampling interval (1m, 1h, 1d)."
      max_len: 16
  prohibited_dimensions:
    - "email"
    - "address"
    - "phone"
    - "full_name"
    - "customer_name"
    - "customer_email"

mapping_rules:
  orders_from_array:
    enabled: true
    description: >
      Map an array of normalized orders into per-order metrics (count and revenue).
      Order normalization rules are defined in order_normalization.yaml; this rule assumes
      normalized fields (order_total, currency, channel, store_id).
    expected_input_shape: "payload is array of objects"
    required_fields_hint: ["order_id", "order_total", "currency", "channel", "store_id", "created_at"]
    outputs:
      - metric_name: "orders.count"
        ts_field_hint: "created_at"
        value: 1
        dimensions:
          store_id: "payload[*].store_id"
          channel: "payload[*].channel"
          currency: "payload[*].currency"
          region: "payload[*].region (optional)"
      - metric_name: "revenue.total"
        ts_field_hint: "created_at"
        value_field_hint: "order_total"
        dimensions:
          store_id: "payload[*].store_id"
          channel: "payload[*].channel"
          currency: "payload[*].currency"
          region: "payload[*].region (optional)"
    notes:
      - "Do not include customer identifiers in dimensions."
      - "If currency is missing, quarantine via rules."

  revenue_summary_from_object:
    enabled: true
    description: "Map a revenue summary object into revenue.total metric."
    expected_input_shape: "payload is object"
    required_fields_hint: ["as_of", "revenue_total", "currency"]
    output:
      metric_name: "revenue.total"
      ts_field_hint: "as_of"
      value_field_hint: "revenue_total"
      dimensions:
        store_id: "payload.store_id (optional)"
        channel: "payload.channel (optional)"
        currency: "payload.currency"
        interval: "payload.interval (optional)"

  aov_from_aggregates:
    enabled: true
    description: "Compute average order value from aggregate fields (no per-customer data)."
    expected_input_shape: "payload is object"
    required_fields_hint: ["orders_count", "revenue_total", "currency", "as_of"]
    output:
      metric_name: "aov.value"
      ts_field_hint: "as_of"
      value_expression: "revenue_total / orders_count"
      dimensions:
        store_id: "payload.store_id (optional)"
        channel: "payload.channel (optional)"
        currency: "payload.currency"
        interval: "payload.interval (optional)"
    notes:
      - "Division by zero must be guarded (rules.yaml)."

  inventory_levels_from_array:
    enabled: true
    description: "Map an array of inventory records into inventory.available metrics."
    expected_input_shape: "payload is array of objects"
    required_fields_hint: ["sku", "available", "timestamp", "store_id"]
    output:
      metric_name: "inventory.available"
      ts_selector_priority: ["ts", "timestamp", "updated_at"]
      value_field_hint: "available"
      dimensions:
        store_id: "payload[*].store_id"
        sku: "payload[*].sku"
        category: "payload[*].category (optional)"
        channel: "payload[*].channel (optional)"
        interval: "payload[*].interval (optional)"
    notes:
      - "SKU is allowed; do not include supplier/customer fields."

  webhook_order_event:
    enabled: true
    description: "Map inbound webhook order notifications into PII-safe canonical events."
    expected_input_shape: "payload is object"
    required_fields_hint: ["event_type", "timestamp"]
    output:
      event_type: "ecommerce.order.received"
      ts_field_hint: "timestamp"
      payload_allowlist:
        - "event_type"
        - "order_id_hash"
        - "store_id"
        - "channel"
        - "currency"
        - "order_total"
      notes:
        - "order_id_hash must be derived deterministically (hash) if order_id is sensitive."
        - "Never include customer email/address/phone."

  customer_entity_inference:
    enabled: false
    description: "Disabled by default to avoid PII expansion into canonical entities."

pii_minimization_notes:
  - "Customer identifiers must be hashed if required (order_id_hash)."
  - "Never store email/address/phone/name in canonical dimensions or event payload."
  - "If PII is detected in canonical output, quarantine and open a case."

validation_notes:
  - "All outputs MUST validate against contracts/v1 canonical schemas."
  - "Order normalization rules apply before these mappings (see order_normalization.yaml)."
  - "Dimension limits enforced by base rules/cleansing."

llm_assist:
  enabled: true
  allowed_roles: ["mapping_suggester"]
  approval_gate: "human_required"
  constraints:
    - "LLM must not receive PII samples."
    - "LLM must not propose prohibited dimensions."
    - "LLM must not enable customer entity inference."
  audit_fields_required: ["llm_role", "model_id", "prompt_hash", "output_hash", "approver", "decision"]

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example 1: Orders payload (normalized)
# payload:
#   - { order_id: "123", order_total: 59.99, currency: "USD", channel: "web", store_id: "S1", created_at: "2026-01-21T10:00:00Z" }
# -> metrics:
#   - orders.count value=1 dims={store_id:S1, channel:web, currency:USD}
#   - revenue.total value=59.99 dims={store_id:S1, channel:web, currency:USD}
#
# Example 2: Inventory payload
# payload:
#   - { sku: "SKU1", available: 42, store_id: "S1", timestamp: "2026-01-21T10:00:00Z" }
# -> metric: inventory.available value=42 dims={store_id:S1, sku:SKU1}
# -----------------------------------------------------------------------------
