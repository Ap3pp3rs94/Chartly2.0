version: "1.1"

connector_profile:
  id: "file_system"
  protocol: "file_system"
  kind: "file"
  description: >
    File system connector profile. Supports:
      (A) Production agent-based ingestion with explicit allowlists and hardened permissions.
      (B) Local development direct filesystem ingestion (explicitly gated and disabled outside local).
    Connector-hub schedules jobs. An agent (or local dev runner) reads files and writes raw blobs to blob storage.
  version: "1.1.0"
  status: "active"

source_config_schema:
  required_fields:
    - "roots"
    - "include_globs"
  optional_fields:
    - "exclude_globs"
    - "recursive"
    - "max_depth"
    - "max_file_size_bytes"
    - "poll_interval_seconds"
    - "change_detection"
    - "content_types"
    - "parsing"
    - "rate_limit_rpm"
    - "execution_mode"
  field_docs:
    execution_mode:
      type: "string"
      rules:
        - "agent_only (default) for staging/production."
        - "local_direct allowed ONLY in env=local and when explicitly enabled."
      allowed: ["agent_only", "local_direct"]
    roots:
      type: "array<string>"
      rules:
        - "Absolute paths."
        - "Must be within allowlist (agent allowlist or local allowlist)."
    include_globs:
      type: "array<string>"
      rules:
        - "Glob patterns to include (e.g., **/*.json)."
    exclude_globs:
      type: "array<string>"
    poll_interval_seconds:
      type: "integer"
      default: 300
      rules:
        - "Min 30, max 3600."

file_system:
  access_model:
    production:
      mode: "agent_only"
      agent_required: true
      notes:
        - "Production/staging ingestion MUST use an agent."
        - "Agent runs with least privilege and explicit allowlists."
    local:
      mode: "local_direct_optional"
      enabled_env: "FS_LOCAL_DIRECT_ENABLED"     # must be 'true' to allow
      notes:
        - "Local direct reads are for developer machines only."
        - "Never enable local_direct in staging/production."
  allowlist_policy:
    agent_roots_allowlist_env: "FS_ROOTS_ALLOWLIST"
    local_roots_allowlist_env: "FS_LOCAL_ROOTS_ALLOWLIST"
    deny_hidden_files: true
    deny_system_paths:
      enabled: true
      patterns:
        - "C:\\Windows\\*"
        - "C:\\Program Files\\*"
        - "C:\\ProgramData\\*"
        - "/etc/*"
        - "/proc/*"
        - "/sys/*"
  glob_policy:
    max_include_globs: 50
    max_exclude_globs: 50
  recursion:
    default_recursive: true
    max_depth_default: 10
    hard_max_depth: 25
  size_limits:
    max_file_size_bytes_default: 50000000
    hard_max_file_size_bytes: 200000000
  content_type_detection:
    mode: "extension_then_magic"
    default_content_type: "application/octet-stream"

change_detection:
  modes: ["polling"]
  roadmap_modes: ["event_watch"]
  polling:
    default_interval_seconds: 300
    min_interval_seconds: 30
    max_interval_seconds: 3600
  hashing:
    algorithm: "sha256"
    when: "on_change_or_first_seen"
  state_tracking:
    status: "roadmap"
    notes:
      - "Store cursor state (path + mtime + sha256) keyed by tenant/source."
      - "Prevent reprocessing unchanged files; idempotency remains a safety net."

rate_limiting_and_backpressure:
  defaults:
    rate_limit_rpm: 30
    per_source_concurrency: 2
  backpressure:
    - "Stop scheduling file reads when queue depth exceeds threshold."
    - "Agent/local runner must honor orchestrator throttles."
    - "Avoid disk thrash: cap concurrent reads per root."

payload_handling:
  supported_formats:
    json:
      extensions: [".json"]
      parse: true
    csv:
      extensions: [".csv"]
      parse: false
    text:
      extensions: [".txt", ".log"]
      parse: false
    other:
      extensions: ["*"]
      parse: false
  parsing_policy:
    on_parse_failure: "store_raw"
    max_preview_chars: 2000
  raw_ref_requirements:
    - "Every ingested file must be written to blob store with sha256."
    - "raw_ref must include bucket/key/sha256/content_type/captured_at."
    - "Original file path and file metadata must be stored as job metadata (not canonical output by default)."
  notes:
    - "Never embed file contents into logs or canonical records."

security:
  prohibitions:
    - "No reading outside allowlisted roots."
    - "No following symlinks that escape allowlisted roots."
    - "No ingesting hidden/system files unless explicitly permitted by overlay."
  audit:
    required: true
    record_fields:
      - "tenant_id"
      - "source_id"
      - "job_id"
      - "file_path"
      - "file_size_bytes"
      - "raw_sha256"

observability:
  required_metrics:
    - "fs.files_seen_total"
    - "fs.files_ingested_total"
    - "fs.bytes_ingested_total"
    - "fs.errors_total"
  required_log_fields:
    - "ts"
    - "service=connector-hub"
    - "tenant_id"
    - "source_id"
    - "job_id"
    - "execution_mode"
    - "file_path"
    - "file_size_bytes"
    - "raw_sha256"

llm_assist:
  enabled: true
  allowed_roles: ["schema_drift_explainer"]
  forbidden:
    - "suggest_accessing_unlisted_paths"
    - "auto_apply_allowlist_changes"
    - "enable_local_direct_outside_local"
  approval_gate: "human_required"
  audit_fields_required: ["llm_role", "model_id", "prompt_hash", "output_hash", "approver", "decision"]

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example 1: Local direct ingestion (local only; requires FS_LOCAL_DIRECT_ENABLED=true)
# source:
#   kind: file
#   connector: file_system
#   config:
#     execution_mode: "local_direct"
#     roots: ["C:\\Data\\exports"]
#     include_globs: ["**/*.json"]
#     exclude_globs: ["**/tmp/**"]
#     poll_interval_seconds: 300
#
# Example 2: Production agent-only ingestion
# config:
#   execution_mode: "agent_only"
#   roots: ["/data/exports"]
#   include_globs: ["**/*.json"]
# -----------------------------------------------------------------------------
