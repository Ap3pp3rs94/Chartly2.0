version: "1.0"

connector_profile:
  id: "graphql"
  protocol: "graphql"
  kind: "api"
  description: >
    GraphQL connector profile. Defines how GraphQL API sources are configured, invoked,
    paginated, rate-limited, retried, and audited by connector-hub.
  version: "1.0.0"
  status: "active"

source_config_schema:
  required_fields:
    - "endpoint"
    - "query"
  optional_fields:
    - "operation_name"
    - "variables"
    - "headers"
    - "timeout_seconds"
    - "rate_limit_rpm"
    - "per_domain_concurrency"
    - "retries"
    - "pagination"
    - "accept"
    - "tls"
  field_docs:
    endpoint:
      type: "string"
      rules:
        - "Must be absolute URL; https:// preferred."
        - "No credentials in URL."
    query:
      type: "string"
      rules:
        - "Must be deterministic and stored in config (not generated dynamically by LLM at runtime)."
        - "Avoid selecting unnecessary fields (minimize payload size)."
    operation_name:
      type: "string"
      rules:
        - "Optional; recommended for observability."
    variables:
      type: "object"
      rules:
        - "Must be deterministic per job."
        - "No secrets; secrets belong in headers via env refs."
    headers:
      type: "object"
      rules:
        - "Authorization values must reference env vars (e.g., 'Bearer ${ENV:TOKEN}')."
        - "No secret literals."
    pagination:
      type: "object"
      rules:
        - "Must be bounded by safety limits."
    timeout_seconds:
      type: "integer"
      default: 30
      rules:
        - "Must be between 1 and 120."

graphql:
  endpoint_policy:
    require_https: false
    forbid_embedded_credentials: true
  operation_rules:
    allow_mutations: false     # base safe default; domain overlays may enable explicitly
    notes:
      - "Ingestion is read-oriented; mutations are discouraged unless explicitly required and audited."
  variables_policy:
    allow: true
    forbid_secret_literals: true
    max_variables: 50
  headers_policy:
    env_ref_syntax: "${ENV:VAR_NAME}"
    required_headers:
      User-Agent: "Chartly/2.0"
      Content-Type: "application/json"
    forbidden_header_keys:
      - "Proxy-Authorization"
  persisted_queries:
    status: "roadmap"
    notes:
      - "Persisted queries reduce payload size and improve security; implement later."

pagination:
  supported_modes: ["cursor", "relay"]
  defaults:
    mode: "relay"
  relay:
    cursor_variable: "after"
    page_size_variable: "first"
    max_pages: 100
    max_nodes: 10000
    stop_when_end_cursor_null: true
  cursor:
    cursor_variable: "cursor"
    page_size_variable: "limit"
    max_pages: 200
    max_nodes: 20000
  safety_limits:
    max_total_requests_per_job: 300
    max_total_bytes_per_job: 50000000
    notes:
      - "Abort safely if max pages/nodes exceeded; emit ingestion health warning/error."

rate_limiting:
  defaults:
    rate_limit_rpm: 60
    per_domain_concurrency: 8
  upstream_respect:
    - "Honor Retry-After header (if surfaced via gateway/proxy)."
    - "Apply jitter to retries."
  enforcement:
    location: "connector-hub"
    keys: ["tenant_id", "source_id", "host"]

retries_and_circuit_breakers:
  retry_policy:
    retry_on_transport_errors: true
    retry_on_status: [408, 429, 500, 502, 503, 504]
    max_attempts: 3
    base_backoff_ms: 750
    max_backoff_ms: 12000
    jitter: true
  graphql_error_handling:
    # GraphQL responses can include both data and errors.
    allow_partial_data: true
    on_errors_present: "store_and_emit_warning"   # store_and_emit_warning|fail
    notes:
      - "Partial data can be useful; still store raw payload and let normalizer decide."
  circuit_breaker:
    enabled: true
    failure_threshold: 8
    open_seconds: 90
    half_open_probe_requests: 2

payload_handling:
  accepted_content_types:
    - "application/json"
    - "application/*+json"
  max_payload_bytes: 10000000
  raw_ref_requirements:
    - "Always write full GraphQL response as raw payload (including errors array)."
    - "Compute sha256 and emit raw_ref pointer for downstream normalization."

observability:
  required_metrics:
    - "graphql.requests_total"
    - "graphql.errors_total"
    - "graphql.latency_ms_p95"
    - "graphql.partial_data_total"
    - "circuit_breaker.opens_total"
  required_log_fields:
    - "ts"
    - "service=connector-hub"
    - "tenant_id"
    - "source_id"
    - "request_id"
    - "job_id"
    - "host"
    - "operation_name"
    - "status_code"
    - "latency_ms"
    - "raw_sha256"
  notes:
    - "Never log full query strings or response bodies in production logs."

llm_assist:
  enabled: true
  allowed_roles:
    - "schema_drift_explainer"
    - "mapping_suggester"
  forbidden:
    - "include_secret_values"
    - "auto_apply_query_changes"
    - "enable_mutations_without_human_approval"
  approval_gate: "human_required"
  audit_fields_required:
    - "llm_role"
    - "model_id"
    - "prompt_hash"
    - "output_hash"
    - "approver"
    - "decision"

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example 1: Basic relay pagination query
# source:
#   kind: api
#   connector: graphql
#   config:
#     endpoint: "https://api.example.com/graphql"
#     operation_name: "ListItems"
#     query: |
#       query ListItems($first: Int!, $after: String) {
#         items(first: $first, after: $after) {
#           pageInfo { hasNextPage endCursor }
#           nodes { id createdAt price }
#         }
#       }
#     variables:
#       first: 100
#     pagination:
#       mode: "relay"
#
# Example 2: Bearer auth via env var
# config:
#   headers:
#     Authorization: "Bearer ${ENV:EXAMPLE_API_TOKEN}"
# ----------------------------------------------------------------------------
