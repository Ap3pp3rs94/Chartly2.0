# Chartly 2.0  New Mapping Template
# Use this template to create: profiles/domains/<DOMAIN_NAME>/mappings.yaml
# This file extends profiles/core/base/mappings.yaml and defines domain-safe mapping rules.

version: "1.0"

inherits:
  base_mappings_file: "profiles/core/base/mappings.yaml"
  override_strategy:
    - "extend: mapping_rules"
    - "override: domain naming + standard dimensions"
    - "do_not_change: determinism rules, raw_ref binding, contract enforcement"

domain_naming:
  metric_prefixes:
    primary: "<DOMAIN_PREFIX>"      # e.g., finance, ecommerce, healthcare, ops
  metric_name_convention:
    - "dot.separated.namespaces"
    - "Examples: <DOMAIN_PREFIX>.kpi.value, <DOMAIN_PREFIX>.events.count"
  event_types:
    convention: "<DOMAIN_PREFIX>.<topic>.<action>"
    examples:
      - "<DOMAIN_PREFIX>.data.received"
      - "<DOMAIN_PREFIX>.pipeline.quarantined"

standard_dimensions:
  required:
    - key: "<DIM_KEY_1>"
      description: "<DESC>"
      max_len: 64
  optional:
    - key: "<DIM_KEY_2>"
      description: "<DESC>"
      max_len: 64
  prohibited_dimensions:
    - "password"
    - "secret"
    - "token"
    - "api_key"
    # Add domain-specific PII/PHI prohibitions here (email, address, etc.)

mapping_rules:
  <RULE_ID_1>:
    enabled: true
    description: "<WHAT_THIS_RULE_DOES>"
    expected_input_shape: "<payload is object|payload is array of objects>"
    required_fields_hint: ["<field1>", "<field2>"]
    output:
      # Choose ONE: metric or event
      metric_name: "<DOMAIN_PREFIX>.<metric_name>"
      ts_field_hint: "<timestamp_field>"
      value_field_hint: "<numeric_field>"
      dimensions:
        <DIM_KEY_1>: "<payload.path.to.value>"
        <DIM_KEY_2>: "<payload.optional.path>"
    notes:
      - "All outputs must include tenant_id, source_id, raw_ref (bound from job context)."
      - "Avoid high-cardinality dimensions."

  entity_inference:
    enabled: false
    description: "Disabled by default. Enable only with explicit domain justification and compliance notes."

validation_notes:
  - "All outputs MUST validate against contracts/v1 canonical schemas."
  - "Cleansing and rules enforcement apply after mapping."
  - "If mapping emits prohibited dimensions or PHI/PII, quarantine must trigger."

llm_assist:
  enabled: true
  allowed_roles: ["mapping_suggester"]
  approval_gate: "human_required"
  forbidden:
    - "include_secret_values"
    - "enable_entity_inference"
    - "auto_apply_changes"
  required_output_format:
    proposed_changes:
      file: "profiles/domains/<DOMAIN_NAME>/mappings.yaml"
      type: "yaml_patch"
      rules:
        - "Only modify mapping_rules.* or domain_naming/standard_dimensions."
        - "Do not weaken determinism or contract enforcement."
  audit_fields_required:
    - "llm_role"
    - "model_id"
    - "prompt_hash"
    - "output_hash"
    - "approver"
    - "decision"

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example 1: Array payload -> metrics
# payload:
#   - { ts: "2026-01-21T10:00:00Z", value: 12.3, region: "US" }
# -> metric: <DOMAIN_PREFIX>.kpi.value ts=... value=12.3 dims={region:US}
#
# Example 2: Webhook payload -> event
# payload:
#   { event_type: "created", timestamp: "2026-01-21T10:00:00Z" }
# -> event: <DOMAIN_PREFIX>.entity.created payload_allowlist={event_type}
# -----------------------------------------------------------------------------
