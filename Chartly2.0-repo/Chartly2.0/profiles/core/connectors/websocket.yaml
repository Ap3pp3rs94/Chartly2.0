version: "1.0"

connector_profile:
  id: "websocket"
  protocol: "websocket"
  kind: "api"
  description: >
    WebSocket connector profile for streaming ingestion. Connector-hub establishes WebSocket connections,
    subscribes to streams, batches inbound messages into raw blobs, and emits normalize jobs. Includes
    strict backpressure, reconnection, and auditing guidance.
  version: "1.0.0"
  status: "active"

source_config_schema:
  required_fields:
    - "url"
  optional_fields:
    - "headers"
    - "subprotocols"
    - "tls"
    - "subscriptions"
    - "message_format"
    - "batching"
    - "buffer_limits"
    - "reconnect"
    - "rate_limits"
  field_docs:
    url:
      type: "string"
      rules:
        - "Must be ws:// or wss:// URL."
        - "No credentials embedded."
    headers:
      type: "object"
      rules:
        - "Auth values must be env-var refs only."
        - "No secret literals."
    subscriptions:
      type: "array<object>"
      rules:
        - "Messages to send upon connect to subscribe."
        - "Must be deterministic."
    batching:
      type: "object"
      rules:
        - "Batches messages into raw blobs with bounded size/time."
    buffer_limits:
      type: "object"
      rules:
        - "Must define max buffered messages/bytes to prevent memory runaway."
    reconnect:
      type: "object"
      rules:
        - "Defines reconnect behavior on disconnect/errors."

websocket:
  url_policy:
    require_wss_in_prod: true
    forbid_embedded_credentials: true
  headers_policy:
    env_ref_syntax: "${ENV:VAR_NAME}"
    required_headers:
      User-Agent: "Chartly/2.0"
    forbidden_header_keys:
      - "Proxy-Authorization"
  subprotocols:
    allowed: true
    max_count: 5
  tls:
    defaults:
      verify: true
      min_version: "1.2"

streaming:
  subscription_model:
    enabled: true
    send_on_connect:
      # Implementations send these frames after handshake.
      enabled: true
      frames: []   # source config can supply frames
    heartbeat:
      enabled: true
      interval_seconds: 30
      mode: "ping"      # ping|message
  message_framing:
    supported_formats: ["json", "text"]
    default_format: "json"
    binary_handling: "reject"     # reject|store_raw (base rejects)
  batching_strategy:
    enabled: true
    mode: "time_or_size"
    max_batch_seconds: 5
    max_batch_messages: 500
    max_batch_bytes: 5000000      # 5MB
    flush_on_disconnect: true
  buffer_limits:
    max_buffered_messages: 5000
    max_buffered_bytes: 20000000  # 20MB
    on_exceed:
      action: "apply_backpressure"   # apply_backpressure|drop_oldest|disconnect
      notes:
        - "Prefer applying backpressure or disconnecting; never unbounded buffering."

reconnect:
  enabled: true
  strategy: "exponential_backoff"
  max_attempts: 0          # 0 = unlimited
  base_backoff_ms: 500
  max_backoff_ms: 30000
  jitter: true
  reset_session_on_reconnect: true
  notes:
    - "Reconnect should re-emit subscription frames."
    - "If upstream provides resume tokens, domain overlays may implement."

rate_limiting_and_backpressure:
  inbound_limits:
    max_messages_per_second: 1000
    max_bytes_per_second: 10000000
  downstream_queue_limits:
    max_pending_batches: 1000
    behavior_when_exceeded: "disconnect_and_retry"
  notes:
    - "WebSocket ingestion can overwhelm downstream quickly; enforce caps strictly."

payload_handling:
  accepted_message_types:
    - "application/json"
    - "text/plain"
  parse_policy:
    on_parse_failure: "store_raw_text_in_batch"   # store_raw_text_in_batch|drop_message
    max_text_preview_chars: 2000
  raw_ref_requirements:
    - "Each batch must be stored as a raw blob with sha256."
    - "raw_ref must reference the batch blob; individual messages are not stored as separate blobs by default."
    - "Batch metadata (message_count, first_ts, last_ts) should be emitted in job meta."

observability:
  required_metrics:
    - "ws.connections_open"
    - "ws.reconnects_total"
    - "ws.messages_in_total"
    - "ws.batches_written_total"
    - "ws.errors_total"
    - "ws.backpressure_events_total"
  required_log_fields:
    - "ts"
    - "service=connector-hub"
    - "tenant_id"
    - "source_id"
    - "job_id"
    - "url"
    - "message_count"
    - "batch_bytes"
    - "raw_sha256"

llm_assist:
  enabled: true
  allowed_roles: ["schema_drift_explainer"]
  forbidden:
    - "include_secret_values"
    - "disable_buffer_limits"
    - "increase_limits_without_human_approval"
  approval_gate: "human_required"
  audit_fields_required: ["llm_role", "model_id", "prompt_hash", "output_hash", "approver", "decision"]

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example: Subscribe to a stream with JSON messages
# source:
#   kind: api
#   connector: websocket
#   config:
#     url: "wss://stream.example.com/ws"
#     headers:
#       Authorization: "Bearer ${ENV:STREAM_TOKEN}"
#     subscriptions:
#       - { op: "subscribe", channel: "trades" }
#     batching:
#       max_batch_seconds: 2
#       max_batch_messages: 200
# -----------------------------------------------------------------------------
