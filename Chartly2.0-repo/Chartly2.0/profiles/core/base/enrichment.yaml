version: "1.0"

enrichment_engine:
  enabled: false
  determinism_rules:
    - "Base profile enrichment is disabled by default."
    - "When enabled, enrichment MUST be deterministic unless explicitly configured otherwise in a domain overlay."
    - "No external network calls in base profile."
    - "No secrets may be introduced by enrichment."
    - "Enrichment MUST NOT add raw payload blobs to canonical outputs."
  execution_order:
    - "derived_enrichments"
    - "external_enrichments"
  failure_handling:
    on_enrichment_failure: "quarantine"   # quarantine|warn|drop
    reason_code: "enrichment.failed"
    notes:
      - "In base profile, enrichment is off; if enabled by overlay, failures are quarantined unless overridden with justification."

derived_enrichments:
  enabled: true
  description: >
    Deterministic derived enrichments that compute additional fields from existing canonical fields.
    These do not require external data access and are safe to apply broadly.
  rules:
    - name: "metric_dimensions_hash"
      applies_to: "Metric"
      when: "dimensions != null"
      add_fields:
        dimensions_hash:
          method: "sha256"
          input: "canonicalized_dimensions_sorted_keys"
      notes:
        - "Used for idempotency composite fallback and debugging."
        - "Must match deduplication.yaml canonicalization rules."

    - name: "event_payload_size_hint"
      applies_to: "Event"
      when: "payload != null"
      add_fields:
        payload_size_hint:
          method: "approx_bytes"
          input: "payload"
      notes:
        - "Approximate only; do not store raw payload content."
        - "Useful for detecting unusually large events."

    - name: "standard_tags"
      applies_to: "Metric"
      when: "true"
      add_fields:
        dimensions:
          merge:
            profile: "core/base"
            profile_version: "1.0.0"
      notes:
        - "Adds stable profile tags for downstream analytics."

external_enrichments:
  enabled: false
  description: >
    External enrichments (HTTP/DB/KV lookups) are disabled in the base profile.
    Domain overlays may enable them with explicit gating, audit, and compliance controls.
  allowed_types:
    - "http_lookup"
    - "db_lookup"
    - "kv_store"
    - "geoip"
  gating_requirements:
    feature_flag_required: true
    feature_flag_name: "external_enrichments_enabled"
    env_allowlist_required: true
    env_allowlist: ["staging", "production"]
    audit_required: true
    pii_phi_allowed: false
    secret_handling:
      - "No secrets in profile files."
      - "Any credentials must be injected via env vars or secret manager and referenced by name only."
  defaults:
    timeout_seconds: 5
    max_concurrency: 50
    retry:
      max_attempts: 2
      backoff_ms: 500
  notes:
    - "External enrichment expands the attack surface. Keep off unless necessary."
    - "If enabled, all external enrichment calls must be logged as audit artifacts (request/response hashed and stored by reference)."

llm_assist:
  enabled: true
  allowed_roles: ["enrichment_suggester"]
  approval_gate: "human_required"
  required_output_format:
    proposed_changes:
      file: "profiles/core/base/enrichment.yaml"
      type: "yaml_patch"
      rules:
        - "Base profile must keep external_enrichments.enabled = false."
        - "LLM may propose derived_enrichments rules only in base."
        - "Any external enrichment proposal must be for domain overlays, not base."
  audit_fields_required:
    - "llm_role"
    - "model_id"
    - "prompt_hash"
    - "output_hash"
    - "approver"
    - "decision"
  notes:
    - "LLM cannot execute enrichments; it can only suggest rules."

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example: Domain overlay enables an HTTP lookup (requires gating + audit)
# external_enrichments:
#   enabled: true
#   providers:
#     - name: "currency_rates"
#       type: "http_lookup"
#       endpoint_env: "RATES_API_ENDPOINT"
#       auth_env: "RATES_API_TOKEN"
#       cache_ttl_seconds: 3600
#
# Example: Domain overlay derived enrichment computes a normalized SKU
# derived_enrichments:
#   rules:
#     - name: "normalize_sku"
#       applies_to: "Metric"
#       when: "dimensions.sku != null"
#       add_fields:
#         dimensions:
#           merge:
#             sku_normalized: "lower(trim(dimensions.sku))"
# -----------------------------------------------------------------------------
