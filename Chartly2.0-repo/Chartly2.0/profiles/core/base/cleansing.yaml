version: "1.0"

cleansing_engine:
  determinism_rules:
    - "Cleansing MUST be deterministic: no randomness, no time-now, no external state."
    - "Cleansing MUST NOT perform network calls."
    - "Cleansing MUST NOT log raw payload content."
    - "Cleansing MUST preserve raw_ref traceability; never mutate raw blobs."
  execution_order:
    # Apply these in order before mapping:
    - "payload_sanitization"
    - "string_transforms"
    - "timestamp_transforms"
    - "numeric_transforms"
    - "boolean_transforms"
    - "dimension_sanitization"
    - "pii_phi_minimization"
    - "secret_minimization"
  failure_handling:
    # Cleansing failures should not silently pass; they become rule signals.
    on_transform_error: "mark_and_continue"     # mark_and_continue|quarantine_immediately
    mark_fields:
      - "cleansing_errors"
      - "cleansing_warnings"
    notes:
      - "Cleansing errors are surfaced to rules.yaml via ctx flags (e.g., numeric_coercion_failed)."

global_transforms:
  string_transforms:
    enabled: true
    operations:
      - name: "trim_strings"
        applies_to: "all_string_fields"
        action: "trim"
      - name: "normalize_whitespace"
        applies_to: "all_string_fields"
        action: "collapse_internal_whitespace"
      - name: "normalize_newlines"
        applies_to: "all_string_fields"
        action: "convert_crlf_to_lf"
      - name: "safe_utf8"
        applies_to: "all_string_fields"
        action: "replace_invalid_utf8"
    limits:
      max_string_len: 10000
      on_exceed: "truncate"   # truncate|quarantine
      truncation: "keep_prefix"
    notes:
      - "Truncation is deterministic. Oversize strings trigger cleansing_warnings."

  timestamp_transforms:
    enabled: true
    timezone: "UTC"
    operations:
      - name: "parse_known_timestamp_fields"
        fields_hint_priority:
          - "ts"
          - "timestamp"
          - "time"
          - "date"
          - "datetime"
          - "created_at"
          - "updated_at"
        accepted_formats:
          - "rfc3339"
          - "iso8601"
          - "unix_seconds"
          - "unix_millis"
        output: "rfc3339_utc"
        on_failure: "mark_error"  # mark_error|quarantine
    notes:
      - "Actual enforcement (bounds/skew) happens in rules.yaml."

  numeric_transforms:
    enabled: true
    operations:
      - name: "coerce_numeric_strings"
        applies_to: "string_fields_that_look_numeric"
        allow_thousands_separators: false
        allow_currency_symbols: false
        allow_percent_suffix: false
        on_failure: "mark_error"
      - name: "normalize_int_float"
        applies_to: "numeric_fields"
        action: "cast_to_float64"
        on_failure: "mark_error"
    disallow:
      - "NaN"
      - "Infinity"
      - "-Infinity"
    notes:
      - "NaN/Inf detection sets numeric_coercion_failed signal."

  boolean_transforms:
    enabled: true
    operations:
      - name: "coerce_boolean_strings"
        true_values: ["true", "1", "yes", "y"]
        false_values: ["false", "0", "no", "n"]
        on_failure: "mark_error"
    notes:
      - "Boolean coercion is conservative; ambiguous values mark an error."

dimension_sanitization:
  enabled: true
  key_normalization:
    # Dimensions come from mapping outputs. This sanitation is applied to the dimensions map.
    lower_case_keys: true
    replace_spaces_with: "_"
    allowed_key_pattern: "^[a-z0-9_\\-\\.]{1,64}$"
    on_invalid_key:
      action: "drop"              # drop|quarantine
      notes:
        - "Dropping invalid keys reduces cardinality risk; secret-like keys are handled in secret_minimization."
  value_normalization:
    stringify_non_scalars: false
    trim_strings: true
    max_value_len: 256
    on_exceed:
      action: "truncate"
      truncation: "keep_prefix"
  truncation_policy:
    max_dimensions_per_record: 64
    on_exceed:
      action: "drop_excess"
      drop_order: "sorted_key_order"
  drop_policy:
    drop_null_values: true
    drop_empty_strings: false

payload_sanitization:
  enabled: true
  max_payload_depth: 6
  max_array_items: 500
  remove_large_blobs:
    enabled: true
    max_field_size_bytes_estimate: 200000   # ~200KB heuristic
    action: "drop_field"
    field_name_suffix: "_dropped"
  remove_binary_like_fields:
    enabled: true
    suspicious_value_patterns:
      - "^[A-Za-z0-9+/]{200,}={0,2}$"      # base64-like long strings
    action: "drop_field"
  notes:
    - "Payload sanitization is to prevent accidental huge expansions during mapping."
    - "Raw truth remains in blob store; this only affects the in-memory representation used for mapping."

pii_phi_minimization:
  enabled: true
  strategy: "redact"  # redact|mask|drop
  suspicious_key_patterns:
    # High-signal patterns; domain overlays should refine.
    - "(?i)ssn"
    - "(?i)social[_-]?security"
    - "(?i)dob"
    - "(?i)date[_-]?of[_-]?birth"
    - "(?i)medical"
    - "(?i)diagnosis"
    - "(?i)patient"
    - "(?i)address"
    - "(?i)phone"
    - "(?i)email"
  action_on_match:
    redact_value_with: "[REDACTED]"
    mark_warning: true
    warning_code: "pii_phi_suspected"
  notes:
    - "This does not declare compliance; it is a safety minimization step."
    - "Actual PII/PHI policy enforcement is governed by rules.yaml and domain profiles."

secret_minimization:
  enabled: true
  strategy: "redact"
  suspicious_key_patterns:
    - "(?i)password"
    - "(?i)secret"
    - "(?i)token"
    - "(?i)api[_-]?key"
    - "(?i)private[_-]?key"
    - "(?i)access[_-]?key"
    - "(?i)secret[_-]?key"
  action_on_match:
    redact_value_with: "[REDACTED]"
    mark_error: true
    error_code: "secret_detected"
  notes:
    - "Rules.yaml will quarantine if secret_detected is true."

llm_assist:
  enabled: true
  allowed_roles: ["cleansing_suggester"]
  approval_gate: "human_required"
  required_output_format:
    proposed_changes:
      file: "profiles/core/base/cleansing.yaml"
      type: "yaml_patch"
      rules:
        - "Only add/modify entries under global_transforms or payload_sanitization within existing determinism rules."
        - "Must not disable pii_phi_minimization or secret_minimization in base profile."
  audit_fields_required:
    - "llm_role"
    - "model_id"
    - "prompt_hash"
    - "output_hash"
    - "approver"
    - "decision"

# -----------------------------------------------------------------------------
# EXAMPLES (comments only)
#
# Example: Domain overlay loosens payload depth for trusted internal sources
# payload_sanitization:
#   max_payload_depth: 10
#   max_array_items: 2000
#
# Example: Domain overlay adds currency parsing (only if deterministic and safe)
# numeric_transforms:
#   operations:
#     - name: "parse_currency_string"
#       applies_to: "fields_matching: .*_usd"
#       allow_currency_symbols: true
# -----------------------------------------------------------------------------
